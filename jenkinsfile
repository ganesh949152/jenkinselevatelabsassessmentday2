pipeline {
    agent any
    stages {
        stage('Build') {
            steps {
                echo "Building Docker image..."
                sh 'docker build -t flask-app-image .'
            }
        }
        stage('Test') {
            steps {
                echo "Testing app (basic check)..."
                sh 'python app.py & sleep 5; curl -f http://127.0.0.1:5000 || (echo "Test failed"; exit 1)'
                sh 'kill $(lsof -t -i:5000) || true'
            }
        }
        stage('Deploy') {
            steps {
                echo "Deploying the app..."
                sh 'docker stop flask-app-container || true'
                sh 'docker rm flask-app-container || true'
                sh 'docker run -d --name flask-app-container -p 5000:5000 flask-app-image'
            }
        }
    }
}
